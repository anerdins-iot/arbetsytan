// Minimal schema for Discord bot: user identification, tenant, project channel lookup.
// Uses same database as web app; migrations are run from web.
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id              String        @id @default(cuid())
  discordGuildId  String?       @unique
  Membership      Membership[]
  Project         Project[]
}

model User {
  id          String       @id @default(cuid())
  name        String?
  Account     Account[]
  memberships Membership[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  provider          String
  providerAccountId String
  user              User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Membership {
  id             String          @id @default(cuid())
  userId         String
  tenantId       String
  role           Role            @default(WORKER)
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectMembers ProjectMember[]

  @@unique([userId, tenantId])
}

model Project {
  id                String          @id @default(cuid())
  name              String
  discordChannelId  String?         @unique
  tenantId          String
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectMembers   ProjectMember[]
}

model ProjectMember {
  id           String     @id @default(cuid())
  projectId    String
  membershipId String
  membership   Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, membershipId])
}

enum Role {
  ADMIN
  PROJECT_MANAGER
  WORKER
}
